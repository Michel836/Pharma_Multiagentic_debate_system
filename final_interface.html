<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• D√©bat Pharmaceutique - VERSION FINALE</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            padding: 20px; 
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .status {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
        }
        .indicator.ok { background: #28a745; }
        .controls {
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
        }
        button {
            padding: 15px 25px;
            margin: 10px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-test { background: #28a745; color: white; }
        .btn-debate { background: #007bff; color: white; }
        .btn-clear { background: #6c757d; color: white; }
        button:hover:not(:disabled) { transform: translateY(-2px); opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .output {
            padding: 20px;
            min-height: 500px;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
        }
        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 6px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }
        .message.system { border-left-color: #28a745; }
        .message.expert { border-left-color: #17a2b8; }
        .message.error { border-left-color: #dc3545; }
        .timestamp { color: #6c757d; font-size: 12px; }
        .author { font-weight: bold; color: #007bff; }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• D√©bat Pharmaceutique qwen3:4b</h1>
            <p><strong>VERSION FINALE</strong> - Proxy int√©gr√©, CORS r√©solu</p>
        </div>
        
        <div class="status">
            <div class="status-item">
                <div class="indicator" id="server-indicator"></div>
                <span>Serveur: <span id="server-status">D√©marrage...</span></span>
            </div>
            <div class="status-item">
                <div class="indicator" id="ollama-indicator"></div>
                <span>Ollama: <span id="ollama-status">Test...</span></span>
            </div>
            <div class="status-item">
                <div class="indicator" id="model-indicator"></div>
                <span>Mod√®le: <span id="model-status">qwen3:4b</span></span>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn-test" onclick="testConnection()" id="testBtn">
                üîç Test Complet
            </button>
            <button class="btn-debate" onclick="startDebate()" id="debateBtn">
                üöÄ D√©bat Multiagent
            </button>
            <button class="btn-clear" onclick="clearOutput()">
                üóëÔ∏è Effacer
            </button>
        </div>
        
        <div class="output" id="output">
            <div class="message system">
                <span class="author">SYST√àME FINAL</span> - 
                <span class="timestamp" id="loadTime"></span><br>
                Interface avec proxy int√©gr√© charg√©e. Test automatique en cours...
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let isDebating = false;
        
        // Afficher l'heure de chargement
        document.getElementById('loadTime').textContent = new Date().toLocaleTimeString();
        
        // Mettre √† jour les indicateurs de statut
        function updateStatus(type, status, text) {
            document.getElementById(`${type}-indicator`).className = `indicator ${status}`;
            document.getElementById(`${type}-status`).textContent = text;
        }
        
        function addMessage(type, author, text, timestamp = null) {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            
            const time = timestamp || new Date().toLocaleTimeString();
            div.innerHTML = `
                <span class="author">${author}</span> - 
                <span class="timestamp">${time}</span><br>
                ${text}
            `;
            
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            document.getElementById('output').innerHTML = `
                <div class="message system">
                    <span class="author">SYST√àME</span> - 
                    <span class="timestamp">${new Date().toLocaleTimeString()}</span><br>
                    Interface nettoy√©e. Pr√™t pour nouveaux tests.
                </div>
            `;
        }
        
        async function testConnection() {
            const btn = document.getElementById('testBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> Test en cours...';
            
            updateStatus('server', 'ok', 'Actif');
            addMessage('system', 'TEST PROXY', 'D√©marrage test via proxy int√©gr√© /ollama/api/*');
            
            try {
                // Test 1: Tags via proxy
                addMessage('system', '√âTAPE 1', 'Test /ollama/api/tags (via proxy serveur)');
                
                const response1 = await fetch('/ollama/api/tags', {
                    method: 'GET'
                });
                
                addMessage('system', 'PROXY', `Status: ${response1.status} ${response1.statusText}`);
                
                if (response1.ok) {
                    const data = await response1.json();
                    const models = data.models.map(m => m.name).join(', ');
                    addMessage('system', 'MOD√àLES', `Disponibles: ${models}`);
                    updateStatus('ollama', 'ok', 'Connect√©');
                    
                    if (models.includes('qwen3:4b')) {
                        updateStatus('model', 'ok', 'Disponible');
                        
                        // Test 2: G√©n√©ration
                        addMessage('system', '√âTAPE 2', 'Test g√©n√©ration via proxy...');
                        
                        const response2 = await fetch('/ollama/api/generate', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: 'qwen3:4b',
                                prompt: 'R√©ponds exactement "PROXY FONCTIONNE" en 2 mots',
                                stream: false,
                                options: { temperature: 0.1, num_predict: 5 }
                            })
                        });
                        
                        if (response2.ok) {
                            const genData = await response2.json();
                            addMessage('system', 'qwen3:4b', `"${genData.response.trim()}"`);
                            addMessage('system', '‚úÖ SUCC√àS TOTAL', 'Proxy + Ollama + qwen3:4b = 100% fonctionnel!');
                        } else {
                            addMessage('error', '‚ùå G√âN√âRATION', `Erreur: ${response2.status}`);
                        }
                    } else {
                        addMessage('error', '‚ùå MOD√àLE', 'qwen3:4b non trouv√©');
                        updateStatus('model', '', 'Manquant');
                    }
                } else {
                    addMessage('error', '‚ùå PROXY', `√âchec: ${response1.status}`);
                    updateStatus('ollama', '', 'Erreur');
                }
                
            } catch (error) {
                addMessage('error', '‚ùå EXCEPTION', `${error.message}`);
                updateStatus('ollama', '', 'Inaccessible');
            }
            
            btn.disabled = false;
            btn.textContent = 'üîç Test Complet';
        }
        
        async function startDebate() {
            if (isDebating) return;
            
            isDebating = true;
            const btn = document.getElementById('debateBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> D√©bat en cours...';
            
            addMessage('system', 'D√âBAT FINAL', 'üè• Lancement d√©bat pharmaceutique multiagent avec proxy');
            
            const experts = [
                { 
                    name: 'üî¨ Expert R√©glementaire', 
                    specialty: 'Conformit√© GxP et r√©glementations FDA/EMA',
                    focus: 'audit trail et validation des syst√®mes'
                },
                { 
                    name: 'üíä Expert Clinique', 
                    specialty: 'Essais cliniques Phase III',
                    focus: 'int√©grit√© des donn√©es et workflows patients'
                },
                { 
                    name: 'üîç Expert Qualit√©', 
                    specialty: 'Assurance qualit√© pharmaceutique',
                    focus: 'contr√¥les qualit√© et s√©curit√© des donn√©es'
                }
            ];
            
            const topic = "Impl√©mentation d'un syst√®me de logging GxP pour essais cliniques Phase III avec chiffrement end-to-end, audit trail complet et r√©cup√©ration automatique";
            addMessage('system', 'SUJET', topic);
            
            let responses = [];
            
            for (const expert of experts) {
                try {
                    addMessage('expert', expert.name, `‚è≥ Analyse du sujet (${expert.specialty})...`);
                    
                    const startTime = Date.now();
                    const response = await fetch('/ollama/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model: 'qwen3:4b',
                            prompt: `Tu es ${expert.name}, expert en ${expert.specialty}.
Tu te concentres sur ${expert.focus}.

SUJET: ${topic}

Donne ton avis d'expert en 3-4 phrases courtes et techniques. Sois pr√©cis, concret et utilise ton expertise sp√©cifique.

Avis expert:`,
                            stream: false,
                            options: {
                                temperature: 0.3,
                                top_p: 0.8,
                                num_predict: 100
                            }
                        })
                    });
                    
                    const duration = Date.now() - startTime;
                    
                    if (response.ok) {
                        const data = await response.json();
                        const opinion = data.response.trim();
                        addMessage('expert', expert.name, `${opinion}<br><em>‚ö° G√©n√©r√© en ${duration}ms</em>`);
                        responses.push({ expert: expert.name, opinion, duration });
                    } else {
                        addMessage('error', expert.name, `‚ùå Erreur HTTP ${response.status}`);
                    }
                    
                } catch (error) {
                    addMessage('error', expert.name, `‚ùå Erreur: ${error.message}`);
                }
                
                // Pause entre experts
                await new Promise(resolve => setTimeout(resolve, 1500));
            }
            
            // Synth√®se finale
            if (responses.length >= 2) {
                const avgDuration = responses.reduce((sum, r) => sum + r.duration, 0) / responses.length;
                addMessage('system', 'üìä SYNTH√àSE', `D√©bat r√©ussi avec ${responses.length}/3 experts. Performance moyenne: ${avgDuration.toFixed(0)}ms par r√©ponse.`);
                addMessage('system', 'üéâ SUCC√àS', 'D√©bat pharmaceutique multiagent compl√©t√© avec proxy int√©gr√© !');
            } else {
                addMessage('system', '‚ö†Ô∏è PARTIEL', 'D√©bat partiellement r√©ussi, certains experts ont √©chou√©.');
            }
            
            isDebating = false;
            btn.disabled = false;
            btn.textContent = 'üöÄ D√©bat Multiagent';
        }
        
        // Test automatique au chargement
        window.addEventListener('load', () => {
            setTimeout(() => {
                updateStatus('server', 'ok', 'Proxy actif');
                testConnection(); // Test automatique
            }, 1000);
        });
    </script>
</body>
</html>